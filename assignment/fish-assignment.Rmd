---
output: 
  github_document:
    df_print: tibble
---

```{r}
library(tidyverse)
library(readxl)
```

```{r}
options(timeout=1000)
```

```{r}
download.file("https://zenodo.org/record/7814638/files/RAMLDB%20v4.61.zip?download=1",
              "fish.zip")

```


```{r}
xlsx <- "Excel/RAMLDB v4.61 (assessment data only).xlsx"
readxl::excel_sheets(xlsx)
```

```{r}
ts1 <- read_xlsx(xlsx, sheet = "timeseries.1")
ts2 <- read_xlsx(xlsx, sheet = "timeseries.2")
assess<-read_xlsx(xlsx,sheet = "assessment")


ts <- bind_rows(ts1, ts2) |>
      distinct() |> 
      filter(tsid == "TCbest-MT")
ts
```



```{r}
metrics <- read_xlsx(xlsx, sheet = "tsmetrics")

units <- metrics |> 
  filter(tscategory == "CATCH or LANDINGS") |>
  filter(tsunitslong == "Metric tons")
metrics
```


```{r}

ts <- ts |> left_join(metrics, by=c("tsid" = "tsunique"))
ts
```

```{r}
stock <- read_xlsx(xlsx, sheet = "stock")
stock
#units <- stock |> 
  #filter(tscategory == "CATCH or LANDINGS") |>
  #filter(tsunitslong == "Metric tons")
ts <- ts |> left_join(stock)
ts
```

```{r}
most_recent <-
  assess |> 
  left_join(stock) |>
  filter(commonname == "Atlantic cod") |>
  filter(mostrecent == 999) |>
  select(assessid)
most_recent

least_recent <-
  assess |> 
  left_join(stock) |>
  filter(commonname == "Atlantic cod") |>
  filter(mostrecent == 0) |>
  select(assessid)
least_recent
```





```{r}
area <- read_xlsx(xlsx, sheet = "area")
area
```

```{r}
ts <- ts |> left_join(area)
ts
```

```{r}
cod <- ts |>
  filter(scientificname == "Gadus morhua") |>
  filter(country=="Canada") |>
  filter(tsyear > 1957) |>
  inner_join(most_recent, by = "assessid") 
cod
#cod2 1850-1945 correct
cod2 <- ts |>
  filter(scientificname == "Gadus morhua") |>
  filter(country=="Canada") |>
  filter(tsyear < 1957) |>
  inner_join(least_recent, by = "assessid") 
cod2
cod |>
  group_by(tsyear) |>
  summarize(total = sum(tsvalue, na.rm = TRUE)) |>
  ggplot(aes(tsyear,total)) + geom_point() +geom_line()

cod2 |>
  group_by(tsyear) |>
  summarize(total = sum(tsvalue, na.rm = TRUE)) |>
  ggplot(aes(tsyear,total)) + geom_point() +geom_line()

```

```{r}
cod_2J3KL <- cod |>
  filter(stockid=="COD2J3KL") |>
  filter(areaid== "Canada-DFO-2J3KL") |>
  inner_join(most_recent, by = "assessid") 
cod2J3KL_post1957 <- cod_2J3KL |>
  group_by(tsyear) |>
  summarise(total = sum(tsvalue, na.rm = TRUE))
cod2J3KL_post1957 |> ggplot(aes(tsyear,total)) + geom_line() + geom_point()
cod2J3KL_pre1957 <- cod2 |>
  filter(stockid=="COD2J3KL") |>
  filter(areaid== "Canada-DFO-2J3KL") |>
  inner_join(least_recent, by = "assessid") |> 
  group_by(tsyear) |>
  summarise(total = sum(tsvalue, na.rm = TRUE)) |>
  filter(tsyear < 1957)
cod2J3KL_pre1957 |> ggplot(aes(tsyear,total)) + geom_line() + geom_point()
cod2J3KL_ALL <- rbind(cod2J3KL_post1957, cod2J3KL_pre1957)
ggplot(cod2J3KL_ALL, aes(tsyear, total, group = 1)) +
  geom_line() + geom_point()
  
```

```{r}
cod_2J3KL_new <- cod_2J3KL |>
  select(tsyear, tsvalue,stockid, areaid) |>
  mutate(max_harvest = max(tsvalue),
         collapsed= (tsvalue < max_harvest*0.1)) |>
  filter(tsyear > 1968)

cod_2J3KL_new

  
```




















```







# Unit 2: Fisheries Collapse Module

This module will focus on understanding and replicating fisheries stock assessment data and fisheries collapse.

Instead of working with independent data.frames, we will be working with a large relational database which contains many different tables of different sizes and shapes, but that all all related to each other through a series of different ids.

## The Database

We will use data from the [RAM Legacy Stock Assessment Database](https://www.ramlegacy.org/database/)

# Exercise 1: Investigating the North-Atlantic Cod

Now we are ready to dive into our data. First, We seek to replicate the following figure from the Millennium Ecosystem Assessment Project using the RAM data.

![](http://espm-157.carlboettiger.info/img/cod.jpg)

## placeholder

------------------------------------------------------------------------

# Exercise 2: Group Assignment

## Stock Collapses

We seek to replicate the temporal trend in stock declines shown in [Worm et al 2006](http://doi.org/10.1126/science.1132294):

![](http://espm-157.carlboettiger.info/img/worm2006.jpg)
